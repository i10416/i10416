# 仕様と実装詳細


ソフトウェアの「仕様」とは、そのソフトウェアが提供する振る舞いについて、利用者が安心して依存できる範囲を定めた“契約”です。
ここで言う「利用者」とは、必ずしも人間だけでなく、他のソフトウェアも含みます。

対して「実装」は、仕様に沿って実際に動作するように書かれた具体的なプログラムそのものを指します。

ソフトウェアの提供者（＝実装者）と利用者は、仕様を通して合意します。

極端に単純化した例を挙げると、「整数型の配列内の要素を昇順に並べる」というのが "仕様" で、
その仕様を満たすためにバブルソートを使うのか、クイックソートを使うのか、はたまた ボゴソートを使うのかを決めるのが“実装”です。

仕様は抽象的すぎても具体的すぎてもいけません。
抽象的すぎる仕様はそのソフトウェアの利用者にとってほとんど何の保証にもならず、実用に耐えません。

もしある関数が `URL` 型を返すと決まっていれば利用者はその返り値から `host` や `path` を安全に取り出せます。
しかし、返り値が `"cccece39b5c9114b19e5dc6db014d90d"` のようなランダムな文字列だったり、
`{ name: "John", age: 42, luckyNumber: 1729 }` のような構造体だったりするような関数に、何を期待できるでしょうか？
そのような仕様では、使いようがありません。

一方で、仕様が実装詳細に踏み込みすぎるのも問題です。
前提として、仕様は利害関係者間の取り決めであり、頻繁に変えるべきではありません。

たとえば、サードパーティのライブラリの挙動や、ミドルウェアの動作仕様を「自分のソフトウェアの仕様」としてしまうと、そのライブラリがバージョンアップされた瞬間に仕様が破綻するおそれがあります。
また、たとえ内部実装が自分の支配下にあったとしても、仕様に漏れ出した実装詳細によって、仕様を守ったまま後から内部構造を変更する自由を失ってしまいます。

要するに、仕様は利用者にとって実用的な程度には具体的でありつつ、内部の実装を柔軟に変更できる程度には抽象的である必要があります。
実装にはさまざまなトレードオフがあるため、仕様が常に一つの実装に結びつくとは限りませんが、仕様は実装の選択肢を適切に絞り込むための有力な手段です。


よく書かれた仕様は、ソフトウェアに「問題」があったとき、実装が仕様に違反しているのか、
利用者が仕様で保証されない振る舞い(≒実装)に依存しているのか、仕様が曖昧でソフトウェアの提供者と利用者が議論すべきなのかを明確にします。

これはチーム開発、特にマイクロサービス開発において非常に重要です。
「問題」があったときに実装者側のコードに責任があるのか(実装者が仕様を守るようにコードを書き直すべきか)、
利用者側のコードに責任があるのか(利用者が実装詳細に依存しないようにコードを書き直すべきか)、
あるいは仕様それ自体に責任があるのか(実装者と利用者が協議し、より明確な仕様を策定すべきか)を明確にします。

このように、誰が修正すべきかを仕様を根拠に合意できるからこそ、健全なチーム開発が成立します。

逆に、仕様が不明瞭であれば、問題の責任は論理ではなく、力関係や空気で決まるようになります。
「なんとなく」「前は動いてた」「言われてないけど期待してた」──そんな根拠で仕様が歪められると、不信と混乱がチームに蔓延します。


仕様をスポーツで例えると仕様はスポーツの「ルール」です。
ルール（＝仕様）は、許される行為と禁じられる行為を定義することで、競技を成立させます。
すべてのプレイヤーが共通のルールを理解し、従っているからこそ、互いの行動が意味を持ち、価値が生まれます。

その一方で、戦略や戦術（＝実装）はチームごとに異なってよいものです。
同じルールのもとで、日本のチームはパスとチームワークを重視するかもしれませんし、欧米のチームはフィジカルを活かした戦術を選ぶかもしれません。

ルールは、さまざまなチーム・プレイヤーの振る舞いが妥当なのか不正なのか判断できる程度に抽象的でなければなりません。
特定のチーム・選手や特定の戦略・戦術を前提にしたルールを定めるべきではありません。
ルールが抽象的すぎると、なんでもありになってゲームが成立しなくなるかもしれません。
ルールが具体的すぎると、ほんの少しそのルールに違反したプレーが発生するたびにゲームを中断しなければなりません。
具体的すぎるルールを変えるとそのルールを前提にたてられた戦略・戦術は大きな見直しが必要になるでしょう。


さて、仕様は頻繁に変えるべきではないと書きましたが、変える必要がある場合は、影響を受ける関係者に速やかに通知し、適切な移行措置を取る必要があります。
スポーツの例を使うなら、「2021年ルール」で戦うチームと「2025年ルール」で戦うチームが同じ試合に出たらどうなるでしょうか？
試合になりません。

そのため、ルール改定の際には周知期間や移行期間を設け、全体がスムーズに新しい仕様に適応できるよう配慮しなければなりません。

スポーツのルールがさまざまな要因で改定を重ねてきたように、実際には仕様は最初から完璧ではないことのほうが多いです。
曖昧な仕様が利用者のフィードバックによって洗練されていくこともあれば、先に存在した実装が自然と標準化されて仕様として昇華されることもあります。

したがって、詳細な仕様書を書かず実装からはじめることに何ら問題はないです。

大切なのは、仕様は契約であり、正しく決めるのは難しく、一度決めたら実装ほど簡単には変えられないので
「仕様と実装を切り分ける」という意識と、両者が螺旋階段のように少しずつ改良されていくという理解です。


この文章を読んで、実装詳細を指して「それは仕様です」という表現を使う人が減ることを願います。

ちなみに、個々のソフトウェアやツールの紹介はこの文章の主題とズレるので深入りしませんが、
仕様の策定・更新・伝達を効率化するための代表的な仕組みをいくつか挙げておきます。

- OpenAPI、protobuf、thrift や GraphQL Schema のような IDL
- IDL からコードを生成するコードジェネレータ
- ソフトウェアの配布と更新を自動化する renovate や dependabot

### References
- https://www.cs.cornell.edu/courses/cs3110/2017fa/l/09-abstr/notes.html
- https://tech-blog.tomofiles.net/2020-05-17/the-difference-between-specification-and-implementation/
